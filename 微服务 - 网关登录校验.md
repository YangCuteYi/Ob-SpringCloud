[](微服务%20-%20共享配置管理.md)单体架构时我们只需要完成一次用户登录、身份校验，通过 `ThreadLocal` 就可以在所有业务中获取到用户信息。而微服务拆分后，每个微服务都独立部署，属于不同的线程，不再通过  `ThreadLocal` 共享数据

在微服务中，通过网关来完成登录校验的工作：

- <font color="#ffc000">只需要在网关和用户服务保存秘钥</font>
- <font color="#ffc000"> 只需要在网关开发登录校验功能</font>

![[微服务 网关登录校验流程.png]]

## 1 <font color="#ffc000">校验思想</font>


> [!question] 思考
> 1. 网关路由是配置的，请求转发是 `Gateway` 内部代码，我们如何在转发之前做登录校验？
>  >[[微服务 - 自定义网关过滤器]] 
>  > [[微服务 - 自定义网关过滤器实现登陆校验逻辑]]
> 2. 网关校验 <font color="#ffc000">JWT</font> 之后，如何将用户信息传递给微服务？
> > [[微服务 - 网关过滤器传递用户信息到微服务]]
> 3. 微服务之间也会相互调用，这种调用不经过网关，又该如何传递用户信息？
> > [[微服务 - 微服务之间传递用户信息]]

^589eb5

### 1.1 <font color="#ffc000">网关运行步骤</font>

![[微服务 网关运行步骤.png]]

> [!abstract]+ 执行过程
> 1. <font color="#ffc000">客户端发送请求</font>
> 
> 客户端发送请求到网关，网关内 `HandlerMapping` 对请求做判断，找到对应的路由规则，交给 `WebHandler` 处理
> 
> ---
> 2. <font color="#ffc000">`WebHandler` 加载过滤器链（`Filter chain`）</font>
> 
> `WebHandler` 会加载当前路由下需要执行的过滤器链（**`Filter chain`**），然后按照顺序逐一执行过滤器
> 
> 
> > [!注意] 重点
> > 过滤器链（**`Filter chain`**）内部的逻辑分为 `pre` 和 `post` 两部分，分别会在请求路由到微服务 **<font color="#ffc000">之前</font>** 和 **<font color="#ffc000">之后</font>** 被执行
> 
> ---
> 
> 3. <font color="#ffc000">执行过滤器链的 `pre` 逻辑</font>
> 
> 过滤器链上的所有过滤器的 `pre` 逻辑都依次顺序执行通过后，请求才会被路由到微服务
> 
> ---
> 
> 4. <font color="#ffc000">成功发送到微服务</font>
> 
> ---
> 
> 5. <font color="#ffc000">倒序执行过滤器链的 `post` 逻辑</font>
> 
> 请求返回后，网关会倒序执行过滤器链上所有过滤器的 `post` 逻辑
> 
> ---
> 
> 1. <font color="#ffc000">最终返回响应结果到客户端</font>

^505db2



---

### 1.2 <font color="#ffc000">网关过滤器</font>

在 [[#^505db2|网关执行过程]] 中，过滤器链上末尾的过滤器 `NettyRoutingFilter` 承担了请求转发的作用

如果定义一个过滤器，在其中实现登录校验逻辑，并且将过滤器执行顺序定义到`NettyRoutingFilter` 之前，就能实现 [[#^589eb5|思考1]] 的需求

![[微服务 网关过滤器思想.png]]

实现：[[微服务 - 自定义网关过滤器]]